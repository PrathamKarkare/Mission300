<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MISSION 300 // VOID_INTERFACE</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500&display=swap');
        
        :root {
            --bg-deep: #05070a;
            --panel: #0d1117;
            --neon-blue: #00d4ff;
            --neon-purple: #9d00ff;
            --neon-pink: #ff007a;
            --text: #e2e8f0;
            --border: #1e293b;
        }

        body {
            font-family: 'JetBrains Mono', monospace; background-color: var(--bg-deep);
            color: var(--text); margin: 0; padding: 20px;
            background-image: radial-gradient(circle at 50% 50%, #111827 0%, #05070a 100%);
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* SCI-FI HEADER & PROGRESS */
        .scifi-panel {
            background: var(--panel); border: 1px solid var(--border);
            padding: 30px; border-radius: 4px; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); margin-bottom: 30px;
            clip-path: polygon(0 0, 100% 0, 100% 90%, 95% 100%, 0 100%);
        }

        .scifi-panel::before {
            content: "SYSTEM_STATUS: ACTIVE"; position: absolute; top: 10px; right: 20px;
            font-size: 0.6rem; color: var(--neon-blue); letter-spacing: 2px;
        }

        h1 { 
            font-family: 'Orbitron', sans-serif; text-transform: uppercase; 
            letter-spacing: 5px; color: var(--neon-blue); margin: 0 0 20px 0;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .scanner-line {
            width: 100%; height: 2px; background: var(--neon-blue);
            margin-bottom: 20px; opacity: 0.3; box-shadow: 0 0 10px var(--neon-blue);
        }

        .progress-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .stat-block { border-left: 2px solid var(--neon-purple); padding-left: 15px; }
        .stat-label { font-size: 0.65rem; color: var(--neon-purple); text-transform: uppercase; display: block; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; }

        .bar-container { background: #111; height: 12px; border: 1px solid var(--border); margin: 20px 0; position: relative; }
        #progress-bar { 
            height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            width: 0%; transition: width 2s ease-in-out;
        }

        /* NAVIGATION */
        .nav-cluster { display: flex; gap: 10px; margin-bottom: 30px; }
        .btn-hex { 
            background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue);
            padding: 10px 20px; cursor: pointer; font-family: 'Orbitron'; font-size: 0.7rem;
            transition: 0.3s; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
        }
        .btn-hex.active { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }

        /* FORM & CARDS */
        .interface-box { 
            background: var(--panel); border: 1px solid var(--border); padding: 25px; 
            display: none; border-top: 3px solid var(--neon-blue);
        }
        .interface-box.active { display: block; }

        input, select, textarea { 
            background: #000; border: 1px solid var(--border); color: var(--neon-blue);
            padding: 12px; font-family: 'JetBrains Mono'; width: 100%; margin-top: 5px;
            box-sizing: border-box;
        }
        input:focus { border-color: var(--neon-blue); outline: none; }

        .rest-mode { 
            border: 1px solid var(--neon-pink); padding: 15px; margin: 20px 0;
            color: var(--neon-pink); font-size: 0.8rem; display: flex; align-items: center; gap: 10px;
        }

        .btn-execute {
            background: var(--neon-blue); color: black; border: none; width: 100%;
            padding: 15px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
            margin-top: 20px; transition: 0.2s;
        }
        .btn-execute:hover { filter: brightness(1.2); letter-spacing: 2px; }

        /* ANALYTICS */
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; color: var(--neon-purple); border-bottom: 1px solid var(--neon-purple); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #111; }
        .tag-active { color: var(--neon-blue); font-weight: bold; }
        .tag-rest { color: var(--neon-pink); opacity: 0.6; }

        @media (max-width: 600px) { .chart-row { grid-template-columns: 1fr; } .progress-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="scifi-panel">
        <h1>Mission_300</h1>
        <div class="scanner-line"></div>
        <div class="bar-container"><div id="progress-bar"></div></div>
        <div class="progress-grid">
            <div class="stat-block"><span class="stat-label">Active_Days</span><span class="stat-value" id="stat-active">0</span></div>
            <div class="stat-block"><span class="stat-label">Remaining</span><span class="stat-value" id="stat-remain">300</span></div>
            <div class="stat-block"><span class="stat-label">Sync_Rate</span><span class="stat-value" id="stat-sync">0%</span></div>
        </div>
    </div>

    <div class="nav-cluster">
        <button class="btn-hex active" onclick="switchTab('tab-log', this)">Input_Data</button>
        <button class="btn-hex" onclick="switchTab('tab-data', this)">Analyze_Logs</button>
    </div>

    <section id="tab-log" class="interface-box active">
        <form id="missionForm">
            <div style="margin-bottom:15px"><label>Timestamp</label><input type="date" id="date" required></div>
            
            <div class="rest-mode">
                <input type="checkbox" id="isRest" onchange="toggleRestUI(this.checked)" style="width:18px; height:18px;">
                <span>INITIATE RECOVERY PROTOCOL (REST DAY)</span>
            </div>

            <div id="active-inputs">
                <div style="margin-bottom:15px">
                    <label>Module_Type</label>
                    <select id="category">
                        <option value="Strength">STRENGTH_TRAINING</option>
                        <option value="Cardio">CARDIO_VASCULAR</option>
                        <option value="Sports">SPORT_PADEL_TENNIS</option>
                        <option value="Yoga">MOBILITY_YOGA</option>
                    </select>
                </div>
                <div style="margin-bottom:15px"><label>Duration_Mins</label><input type="number" id="duration"></div>
            </div>
            
            <button type="submit" class="btn-execute">EXECUTE_SYNC</button>
        </form>
    </section>

    <section id="tab-data" class="interface-box">
        <div class="chart-row">
            <div style="background:#000; padding:10px; border:1px solid #1e293b;"><canvas id="chart-bar"></canvas></div>
            <div style="background:#000; padding:10px; border:1px solid #1e293b;"><canvas id="chart-pie"></canvas></div>
        </div>
        <table>
            <thead><tr><th>Date</th><th>Type</th><th>Mins</th><th>Action</th></tr></thead>
            <tbody id="log-body"></tbody>
        </table>
    </section>
</div>

<script>
    // --- FIREBASE CORE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBvmlKaFA2WL_BGbSb9m4RKuYElqHrJwbA",
        authDomain: "mission-300-38a4e.firebaseapp.com",
        projectId: "mission-300-38a4e",
        storageBucket: "mission-300-38a4e.firebasestorage.app",
        messagingSenderId: "693480568946",
        appId: "1:693480568946:web:a231010aaa76071c542aeb",
        measurementId: "G-9JR8MQR73S"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let logs = [];
    let charts = { bar: null, pie: null };
    document.getElementById('date').valueAsDate = new Date();

    // --- LOGIC: DATA LISTENER ---
    db.collection("workouts").orderBy("date", "desc").onSnapshot((snap) => {
        logs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        processInterface();
    });

    function toggleRestUI(checked) {
        document.getElementById('active-inputs').style.opacity = checked ? "0.2" : "1";
        document.getElementById('active-inputs').style.pointerEvents = checked ? "none" : "auto";
    }

    document.getElementById('missionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const isRest = document.getElementById('isRest').checked;
        const data = {
            date: document.getElementById('date').value,
            category: isRest ? 'REST_DAY' : document.getElementById('category').value,
            duration: isRest ? 0 : (parseInt(document.getElementById('duration').value) || 0),
            isRest: isRest,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("workouts").add(data);
        e.target.reset();
        document.getElementById('date').valueAsDate = new Date();
        toggleRestUI(false);
    });

    async function deleteLog(id) {
        if(confirm("PERMANENTLY ERASE DATA?")) await db.collection("workouts").doc(id).delete();
    }

    function processInterface() {
        const body = document.getElementById('log-body');
        body.innerHTML = '';
        
        logs.forEach(l => {
            body.innerHTML += `<tr>
                <td>${l.date}</td>
                <td class="${l.isRest ? 'tag-rest' : 'tag-active'}">${l.category}</td>
                <td>${l.duration}</td>
                <td><button onclick="deleteLog('${l.id}')" style="color:var(--neon-pink); background:none; border:none; cursor:pointer">X</button></td>
            </tr>`;
        });

        // --- NEW BUSINESS RULE LOGIC ---
        // Filter out any entries where isRest is true before counting toward the 300
        const activeDates = new Set(logs.filter(l => !l.isRest).map(l => l.date));
        const activeCount = activeDates.size;
        
        const remain = Math.max(300 - activeCount, 0);
        const rate = ((activeCount / 300) * 100).toFixed(1);

        document.getElementById('stat-active').innerText = activeCount;
        document.getElementById('stat-remain').innerText = remain;
        document.getElementById('stat-sync').innerText = rate + "%";
        document.getElementById('progress-bar').style.width = rate + "%";

        updateVisuals();
    }

    function updateVisuals() {
        // PIE CHART
        const cats = {};
        logs.forEach(l => cats[l.category] = (cats[l.category] || 0) + 1);
        if(charts.pie) charts.pie.destroy();
        charts.pie = new Chart(document.getElementById('chart-pie'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(cats),
                datasets: [{ data: Object.values(cats), backgroundColor: ['#00d4ff', '#9d00ff', '#ff007a', '#1e293b'], borderWidth: 0 }]
            },
            options: { cutout: '80%', plugins: { legend: { display: false } } }
        });

        // BAR CHART
        const timeline = {};
        const sorted = [...logs].filter(l => !l.isRest).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-7);
        sorted.forEach(l => timeline[l.date] = (timeline[l.date] || 0) + l.duration);
        if(charts.bar) charts.bar.destroy();
        charts.bar = new Chart(document.getElementById('chart-bar'), {
            type: 'bar',
            data: {
                labels: Object.keys(timeline),
                datasets: [{ label: 'MINS', data: Object.values(timeline), backgroundColor: '#00d4ff' }]
            },
            options: { scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#00d4ff' } } }, plugins: { legend: { display: false } } }
        });
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.interface-box').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.btn-hex').forEach(h => h.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }
</script>
</body>
</html>